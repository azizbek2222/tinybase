<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Pul Yechib Olish</title>
<style>
    body { font-family: Arial, sans-serif; background: linear-gradient(135deg,#4e9fff,#6ac9ff); text-align:center; padding-top:60px; color: #333;}
    .withdraw-box{background:white;width:300px;margin:auto;padding:30px;border-radius:14px;box-shadow:0 6px 16px rgba(0,0,0,0.2);}
    .box-title{font-size:24px;font-weight:bold;margin-bottom:20px;color:#007bff;}
    input[type="text"], input[type="number"] {
        width: 100%;
        padding: 12px;
        margin: 10px 0;
        display: inline-block;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-sizing: border-box;
        font-size: 16px;
    }
    .submit-btn{
        margin-top: 20px;
        padding: 14px 28px;
        background: linear-gradient(135deg,#00c16e,#00e689);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 18px;
        box-shadow: 0 4px 10px rgba(0,200,120,0.4);
        cursor: pointer;
        width: 100%;
    }
    .back-btn {
        margin-top: 15px;
        padding: 10px 20px;
        background: #f0f0f0;
        color: #007bff;
        border: 1px solid #007bff;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
    }
</style>
</head>
<body>
<div class="withdraw-box">
    <div class="box-title">ðŸ’¸ Pul Yechib Olish</div>
    <form id="withdrawForm">
        <input type="text" id="payeer" placeholder="Payeer Hamyon Raqamingiz (Pxxxxxxx)" required><br>
        <input type="number" id="amount" placeholder="Miqdor (â‚½)" min="1" step="0.01" required><br>
        <button type="submit" class="submit-btn">Soâ€˜rov Yuborish</button>
    </form>
    <button class="back-btn" onclick="location.href='index.html'">Ortga Qaytish</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, push, get, child, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    // index.html dan olingan Firebase konfiguratsiyasi
    const firebaseConfig = {
      apiKey: "AIzaSyDIeG8dVbm0Yk7FR1hPzrBoD7rgDKWAFoY",
      authDomain: "user1111-c84a0.firebaseapp.com",
      databaseURL: "https://user1111-c84a0-default-rtdb.firebaseio.com",
      projectId: "user1111-c84a0",
      storageBucket: "user1111-c84a0.firebasestorage.app",
      messagingSenderId: "901723757936",
      appId: "1:901723757936:web:9da0a1c7ec494f4a0c03b5",
      measurementId: "G-9R8ZQY63B1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbRef = ref(db);
    
    // index.html dan olingan deviceId ni olish
    let deviceId = localStorage.getItem("deviceId");
    if(!deviceId){
        alert("Foydalanuvchi identifikatori topilmadi. Iltimos, avval index.html ni oching.");
        window.location.href = "index.html";
    }

    document.getElementById("withdrawForm").addEventListener("submit", function(e){
        e.preventDefault();
        
        const payeer = document.getElementById("payeer").value.trim();
        const amount = parseFloat(document.getElementById("amount").value);
        
        if (payeer === "" || amount <= 0 || isNaN(amount)) {
            alert("Iltimos, Payeer raqami va to'g'ri miqdorni kiriting.");
            return;
        }

        // Foydalanuvchi balansini tekshirish
        get(child(dbRef, "users/"+deviceId)).then((snapshot) => {
            if (snapshot.exists()) {
                const userData = snapshot.val();
                const currentBalance = userData.balance || 0.00;

                if (amount > currentBalance) {
                    alert("Balansingizda yetarli mablag' mavjud emas. Balansingiz: " + currentBalance.toFixed(2) + " â‚½");
                    return;
                }
                
                // Balans yetarli bo'lsa, so'rovni yuborish
                const withdrawData = {
                    deviceId: deviceId,
                    payeer: payeer,
                    amount: amount.toFixed(2),
                    status: "pending", // So'rov holati
                    timestamp: Date.now()
                };

                // So'rovni "withdrawRequests" bo'limiga qo'shish (admin ko'rishi uchun)
                push(ref(db, "withdrawRequests"), withdrawData)
                .then(() => {
                    // Foydalanuvchi balansini yangilash (kamaytirish)
                    const newBalance = currentBalance - amount;
                    set(ref(db, "users/"+deviceId), {...userData, balance: newBalance})
                    .then(() => {
                        alert(`So'rov muvaffaqiyatli yuborildi: ${amount.toFixed(2)} â‚½ Payeer ${payeer} raqamiga. Balansingiz yangilandi.`);
                        // Yuborilgandan so'ng maydonlarni tozalash
                        document.getElementById("payeer").value = "";
                        document.getElementById("amount").value = "";
                    }).catch((error) => {
                        console.error("Balansni yangilashda xatolik:", error);
                        alert("So'rov yuborildi, ammo balansni yangilashda xatolik yuz berdi. Iltimos, adminga murojaat qiling.");
                    });
                })
                .catch((error) => {
                    console.error("So'rovni yuborishda xatolik:", error);
                    alert("So'rovni yuborishda xatolik yuz berdi. Iltimos, keyinroq urinib ko'ring.");
                });
                
            } else {
                alert("Balans ma'lumotlari topilmadi. Iltimos, index.html orqali qayta urinib ko'ring.");
            }
        }).catch((error) => {
            console.error(error);
            alert("Ma'lumotlar bazasiga ulanishda xatolik.");
        });
    });
</script>
</body>
</html>